# nyaturingtest-enhanced

## 项目简介

本项目是基于 [nonebot-plugin-nyaturingtest](https://github.com/shadow3aaa/nonebot-plugin-nyaturingtest) 的改造版本。

核心目标是将原项目从"重本地算力"转向"重云端API"，在保留核心拟人化交互体验的同时，极大地降低部署门槛和资源消耗。

## ✨ 核心特性

### 1. 轻量化架构 (Lite Architecture)

- **去本地化模型**：移除了原项目中庞大的 `HippoRAG` (图神经网络) 和本地 `BGE-M3` Embedding 模型。
- **云端算力替代**：
  - **Embedding**: 对接 SiliconFlow (硅基流动) 的 Embedding API，速度更快，效果更强。
  - **VLM**: 图片理解模块支持 OpenAI Compatible 和 Google AI Studio 双通道，无需本地显存即可实现高精度识图。
  - **Rerank (重排序)**: 引入 Reranker 模型优化 RAG 检索链路，大幅提升长期记忆召回的准确性。
- **资源占用骤降**：运行时内存占用从 4GB+ 降低至 **200MB 左右**，启动速度提升至秒级。

### 2. 增强的交互逻辑

- **自主意识循环**：采用 `Producer-Consumer` 模型的后台思考循环 (`spawn_state`)，Bot 会根据群聊上下文自主决定是否发言，而非传统的"一问一答"。
- **强制响应机制**：解决了"叫不答应"的问题。当检测到 `@Bot` 或 `回复Bot消息` 时，会自动打破"潜水"状态，强制触发响应逻辑。
- **拟人化状态机**：维护 `潜水` / `冒泡` / `活跃` 三种状态，根据群聊热度动态调整插话频率。
- **多模态感知**: 能够通过 VLM 模型"看见"群聊图片，并将图片内容转化为文本纳入对话上下文，实现真正的"看图说话"。
- **情绪护栏**：基于 VAD 情绪模型动态调整回复风格，并设有护栏机制确保 Bot 在负面情绪下也不会产生攻击性语言。

### 3. 稳定可靠的数据持久化

- **数据库迁移**：从不稳定的 JSON 文件读写全面迁移至 **SQLite + Tortoise-ORM**。
- **实时记忆**：
  - **长期记忆**: 使用 **ChromaDB** 存储向量化记忆，支持实时写入和去重，意外断电不丢数据。
  - **短时记忆**: 采用滑动窗口 + LLM 实时摘要 (`Summary`) 机制，自动压缩历史对话。
- **自动灾备 (New)**：内置基于 `APScheduler` 的全量数据备份系统。
  - 每天凌晨 04:00 自动将 SQLite 与向量库文件打包压缩为 zip。
  - 自动轮转清理机制（仅保留最近 7 天的备份），极大程度避免因意外 `/reset` 带来的"失忆"灾难。
- **配置持久化**: 群组的 Autochat 开启/关闭状态现已存入数据库，重启后不再丢失。
- **按群隔离**: 所有数据（消息、画像、交互日志）按群组独立存储，互不影响。

### 4. 运维与监控

- **Token 智能追踪**: 内置了精确的 Token 消耗统计系统。
  - **全链路覆盖**: 包含 Chat (对话)、VLM (识图)、Feedback (反思) 三大核心环节。
  - **多维度报表**: 支持查看 24小时、7天以及历史总计的消耗情况，并按模型细分。
  - **图片渲染**: 统计结果以精美的卡片图片形式呈现，支持自定义水印。
- **并发控制**：引入 `asyncio.Semaphore` 限制图片处理并发数，防止瞬间大量图片导致内存溢出。
- **后台任务保护**: 所有后台异步任务均配备异常捕获，防止静默失败导致数据丢失。
- **网络优化**：API 请求使用全局 `httpx` 连接池，支持自定义 SSL 配置。

---

## 🛠️ 配置指南

本插件使用 `config.json` 进行配置（位于插件目录下）。首次运行时需要手动创建。

```jsonc
{
  "chat": {
    "provider": "openai_compatible", // 或 "google_ai_studio"
    "api_key": "sk-your-api-key", // OpenAI Compatible API Key
    "base_url": "https://your-api-endpoint/v1/",
    "model": "gemini-3-flash", // 对话模型
    "google_api_key": "", // Google AI Studio API Key (可选)
    "google_base_url": "https://generativelanguage.googleapis.com/v1beta",
  },
  "vlm": {
    "enabled": true, // 是否启用图片理解
    "provider": "openai_compatible", // 或 "google_ai_studio"
    "model": "gemini-3-flash",
    "openai_api_key": "sk-your-api-key",
    "openai_base_url": "https://your-api-endpoint/v1/",
    "google_api_key": "",
    "google_base_url": "https://generativelanguage.googleapis.com/v1beta",
  },
  "feedback": {
    "provider": "openai_compatible", // 反馈/分析模型
    "api_key": "sk-your-api-key",
    "base_url": "https://your-api-endpoint/v1/",
    "model": "gemini-3-flash",
    "google_api_key": "",
    "google_base_url": "https://generativelanguage.googleapis.com/v1beta",
  },
  "siliconflow_api_key": "sk-your-siliconflow-key", // 硅基流动 API Key (Embedding + Rerank)
  "rerank": {
    "model": "BAAI/bge-reranker-v2-m3", // 重排序模型
    "threshold": 0.1, // 重排序阈值 (0-1)
  },
  "token_stats": {
    "watermark": "Generated by HakuBot", // Token 统计卡片水印
  },
  "enabled_groups": [], // 初始启用的群号列表
}
```

> **注意**: `chat`、`vlm`、`feedback` 三个模块可以分别配置不同的 API 端点和模型，以实现成本优化（如：对话用高质量模型，反馈用低成本模型）。

---

## 🎮 指令列表

所有指令仅支持 **SUPERUSER** 使用。大部分指令同时支持群聊和私聊（私聊需附加群号）。

### 群聊指令

| 指令                         | 别名          | 说明                                                               |
| :--------------------------- | :------------ | :----------------------------------------------------------------- |
| `/help`                      | 帮助          | 显示帮助信息                                                       |
| `/autochat <enable/disable>` | -             | 在本群启用或禁用 AI 自动插话（持久化）                             |
| `/status`                    | 状态          | 查看 Bot 状态（情绪、意愿值、记忆等）                              |
| `/role`                      | 当前角色      | 查看当前加载的角色设定                                             |
| `/set_role <角色名> <设定>`  | 设置角色      | 动态修改 Bot 的人设                                                |
| `/presets`                   | preset        | 查看所有可用的预设文件                                             |
| `/set_preset <文件名>`       | set_presets   | 从文件加载角色预设                                                 |
| `/calm`                      | 冷静          | 重置情绪、意愿值和活跃状态（保留记忆和人设）                       |
| `/reset_emotion`             | 重置情绪      | 仅重置 VAD 情绪值（保留意愿值、记忆等）                            |
| `/reset`                     | 重置          | **完全重置**：清空人设、记忆、情绪，并删除数据库中的消息和画像记录 |
| `/token统计`                 | -             | 查看本群及全局的 Token 消耗统计（24h/7d/总计）                     |
| `/查询记忆 <@某人/空>`       | memory / 印象 | 查看 AI 对特定群友的长期记忆与印象                                 |
| `/backup_data`               | 备份数据      | **手动触发数据备份**：立即打包所有插件数据到备份文件夹             |

### 私聊指令

私聊指令通常需要指定群号，格式为：`指令 <群号> [参数]`。

| 指令                              | 说明                 |
| :-------------------------------- | :------------------- |
| `status <群号>`                   | 查看指定群的状态     |
| `set_role <群号> <角色名> <设定>` | 修改指定群的角色     |
| `set_preset <群号> <文件名>`      | 加载指定群的预设     |
| `calm <群号>`                     | 冷静指定群           |
| `reset_emotion <群号>`            | 重置指定群情绪       |
| `reset <群号>`                    | 完全重置指定群       |
| `list_groups` / 群组列表          | 查看所有已启用的群组 |
| `backup_data` / 备份数据          | 手动触发全量数据备份 |

### 重置指令对比

| 功能                       | `/calm` | `/reset_emotion` | `/reset` |
| :------------------------- | :-----: | :--------------: | :------: |
| 重置情绪 (VAD)             |   ✅    |        ✅        |    ✅    |
| 重置用户画像               |   ✅    |   ✅ (仅情绪)    |    ✅    |
| 重置意愿值/活跃状态        |   ✅    |        ❌        |    ✅    |
| 清空短时记忆               |   ❌    |        ❌        |    ✅    |
| 清空向量记忆 (ChromaDB)    |   ❌    |        ❌        |    ✅    |
| 删除数据库记录 (消息/日志) |   ❌    |        ❌        |    ✅    |
| 重置人设为默认             |   ❌    |        ❌        |    ✅    |

---

## 📂 项目架构 (Refactored)

为了提高大型项目的可维护性，插件采用扁平化演进的高内聚包结构划分：

### 1. 业务接入层 (`handlers/`)

- **`commands.py`**: Bot 命令处理入口，负责各种群管/交互指令及手动备份。
- **`memory.py`**: 暴露给普通用户的被动/主动查阅记忆入口，综合生成印象报告。

### 2. 核心调度层 (`core/`)

- **`state_manager.py`**: 管理各群组的 `GroupState` 会话隔离，以及并发原语 (Lock/Event/Task)。
- **`logic.py`**: 包含 `spawn_state` 主循环线程大脑，决策插话策略并控制 Bot 交互时序。
- **`session.py`**: 各群聊会话生命周期的管理与上下文封装。

### 3. 数据层 (`database/`)

- **`repository.py`**: 使用 Tortoise-ORM 封装了底层 SQLite 的所有增删改查逻辑（包含Token统计、长期画像、短时日志等）。
- **`backup.py`**: 守护核心数据的每日凌晨自动化归档备份逻辑。

### 4. 大模型通信层 (`llm/`)

- **`client.py`**: 基于 AsyncOpenAI 封装的高可用大模型通信基类。
- **`vlm.py`**: 提供支持 Google AI Studio / OAI 兼容接口的多模态看图服务模块。

### 5. 记忆与心智 (`memory/`)

- **`short_term.py`**: 滑动窗口记忆。基于消息队列进行即时会话缓存，超容时调用小模型生成摘要。
- **`vector.py`**: ChromaDB 持久化向量检索。结合 Embedding 与 Rerank 双重引擎。
- **`image.py`**: 专门处理图片下载、GIF解析以及并发的看图缓存管理。

### 6. 模型定义 (`models/`)

- **`database.py`**: SQLite 的 ORM 结构模型实体 (Table Schema)。
- **`profile.py`**: 结合了 VAD 模型的心智与衰减公式等逻辑模型实体。
- **`presets.py`**: 基于 pydantic 的预设实体配置项与加载器。

### 7. 提示词工程 (`prompts/`)

- 存放了与预设强绑定、分离管理的不同 prompt 文件。

### 8. 公共配置与工具

- **`config.py`**: JSON 动态配置加载器。
- **`utils.py`**: 通用的工具集 (绘图、格式化、分割等)。

---

## ⚠️ 注意事项

1. **Token 消耗**：
   - Bot 需要不断读取群聊上下文进行"自我思考"（Feedback 阶段），Token 消耗可观。
   - **建议**：使用 `/token统计` 指令定期监控消耗，并为 Feedback 阶段配置成本较低的模型。

2. **数据库文件**：
   - 运行时会在插件数据目录生成 `nyabot.sqlite`，请定期备份。
   - 长期记忆向量库由 ChromaDB 管理，数据位于插件数据目录下。
   - 使用 `/reset` 会**永久删除**该群的所有数据库记录，操作不可逆。

3. **预设文件**：
   - 角色预设 JSON 文件存放在 `config/nyaturingtest/nya_presets/` 目录下。
   - 修改预设后需执行 `/set_preset <文件名>` 重新加载。

## Special Thanks

- **原作者**: [shadow3aaa](https://github.com/shadow3aaa/) 提供的前沿架构思路。
- [**G指导**](https://gemini.google.com/app): 协助完成了代码的重构、Bug 修复以及文档编写。
